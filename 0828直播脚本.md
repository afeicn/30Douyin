# 0828直播脚本

## 直播主题
Trae七周实战训练营——第四课：用户登录系统设计！让玩家拥有个人身份

## 直播内容
### 一、课程导引

#### 飞哥：
大家好，欢迎大家来到Trae七周实战训练营的第四节课，我是你们的老朋友沈飞。

#### 刘泓：
大家好，我是今天的主讲人刘泓。

#### 飞哥：
上节课我们成功地将贪吃蛇游戏的排行榜数据从文件存储升级到了数据库，解决了数据丢失的问题！
现在我们有了数据库存储排行榜，但还有个问题没解决。
**🎬 01-展示当前游戏排行榜界面**
我先给大家看一下我们的排行榜...（展示排行榜）大家看，上面只有名字，没有任何身份信息，评论区的各位伙伴想一想，现在排行榜都存在哪些问题？

#### 刘泓：
现在存在玩家身份识别问题：任何人都可以随便输入名字上榜，同一个人可以用不同名字重复上榜，我们无法知道这些分数是谁创造的。

#### 飞哥：
所以我们需要让每个玩家都能拥有一个自己的身份，那么我们该怎么做呢？

#### 刘泓：
这就需要为游戏添加用户登录系统，用户登录后就拥有了一个唯一的身份。
今天我们会学习如何用vibe coding的方式给游戏制作一个用户登录系统，让你的玩家拥有自己的账号，让排行榜显示唯一的用户信息！

#### 飞哥：
**🎬 02-展示游戏发展史时间轴**
其实游戏不是一开始就有用户系统的，从第二节课到第四节课，我们差不多是带着大家跨越了二十多年的游戏发展历程。稍微有点经历的伙伴可能知道，游戏行业其实是从70年代开始兴起的。那个时候的游戏，大多数是以“单机游戏”的形式发行的，没什么登录的概念。

比如70年代初，出现了街机厅里的各种投币游戏；80年代，掌上游戏机开始普及，像任天堂、索尼、微软等公司都推出了自己的掌上游戏机，经典的《俄罗斯方块》、《超级玛丽》等游戏也开始在这些游戏机上运行。还有八位机时代，就是我们小时候玩的插卡式红白机——这些都属于早期游戏的典型。它们的特点是单机运行，有些支持多个手柄对战，游戏里的人物标识往往就是简单的Player1、Player2，连名字都没有。

到了90年代，随着个人电脑和主机网络服务的爆发，网络游戏开始兴起，账户系统也就变得越来越重要。这里面有一个里程碑式的事件，就是1996年暴雪公司推出的“战网”平台，战网之前，联机游戏已存在实验室与大学场景中，但从战网开始，账户系统与社区功能才开始普及。玩家第一次需要通过账号登录才能玩暴雪旗下的游戏，而且这个平台还集成了好友列表、战绩统计等功能——这其实奠定了后来很多网游社区的基础。像当时非常流行的《星际争霸》，就是依托战网实现了联机对战；而国内玩家熟悉的《剑侠情缘网络版》《传奇》，也是这一时期网络化浪潮下的典型作品。

大家玩过的第一场游戏是什么？（评论区互动）

**🎬 03-展示奖品**
说到这里，也给大家透露一下：我们本期的礼物，是一款怀旧游戏机——“拓麻歌子”。这是万代公司在90年代推出的一款现象级电子宠物机，当时在全球的销量高达8000万台。它其实开创了“情感化交互电子玩具”的先河，像已经停运的QQ宠物、或者这两年很火的旅行青蛙、《动物森友会》里那种情绪陪伴的设计逻辑，最早就是从拓麻歌子这里来的。

老规矩，我们会有3次送礼的时机，大家要准备好抢答题目或完成任务，就可以获得今天的小礼物！
同时，互动榜第一的同学也会额外获得一个神秘奖品——卿科赞助的小度智能音箱随身版。

### 二、知识点1：用户体系与数据库关联设计

#### 飞哥：
言归正传，说到用户体系我们都可以理解，简单来说就是你需要设置一个用户名和密码，每次需要验证密码后完成身份认证，也就是咱们说的登录。是不是这么理解？

#### 刘泓：
简单来说是这样的，但是用户体系并不是单纯为了登录，更重要的是要把所有的业务操作跟用户关联起来。

可以用银行举例，没有用户登录系统就像银行不需要身份证就能开户一样，而解决办法就是建立一个银行账户管理系统，让身份证和交易记录可以关联起来。假如你去银行取了100块钱，通过用户体系就能实现：
* 证明是你的账户（当然这个还不能证明你就是你，这个里面还有实名的问题）
* 在你的账户里取出100块钱，余额相应减少了100（这就避免了影响别人的账户）

因此，在我们的游戏中，也需要有这样一个账户管理体系，能够让用户建立账户，并通过密码管理自己的账户。
那么我们不仅需要在前端添加登录的功能，还需要在后端将用户名和密码存储到数据库中。
上节课，我们建立了一个这样的数据表：

**🎬 04-展示数据表1**
```
leaderboard表
+----+----------+-------+---------------------+
| id | username | score | timestamp           |
+----+----------+-------+---------------------+
| 1  | 小明     | 150   | 2023-05-01 10:00    |
| 2  | 小红     | 120   | 2023-05-01 11:00    |
+----+----------+-------+---------------------+
```

现在我们需要在用户表中添加一个密码字段，用来存储用户的密码。
于是我们的数据表变成了这样：

**🎬 05-展示数据表2**
```
leaderboard表
+----+----------+---------------+-------+---------------------+
| id | username | password_hash | score | timestamp           |
+----+----------+---------------+-------+---------------------+
| 1  | 小明     | 123456        | 150   | 2023-05-01 10:00    |
| 2  | 小红     | 654321        | 120   | 2023-05-01 11:00    |
+----+----------+---------------+-------+---------------------+
```

#### 飞哥：
大家想一想，这样设计会有什么问题？

#### 刘泓：
1. 数据冗余问题：每一行战绩记录，都要存储一遍用户名和密码
2. 数据一致性问题：如果用户名被修改了，那么所有的战绩记录都要修改
3. 用户名不能唯一：如果需要保证用户名唯一，就需要设置username为unique，这会导致一张表无法存储同一用户的多行数据

#### 飞哥：
怎么设计数据库才能解决数据冗余、数据一致性问题？

#### 刘泓：
为了解决这两个问题，这涉及到我们今天要讲的第一个知识点：数据库关联表设计。
通过建立两个相互关联的表，来将身份信息和交易信息关联起来：
● 身份信息（用户表）：记录每个人的真实身份
● 银行交易记录（排行榜表）：每笔交易都关联到具体的身份证号

上节课我们知道了数据库是什么、如何建立一个单表数据库，这节课我们来把它进化为双表数据库。
想要在游戏中实现一个基础的用户登录系统，我们需要这样的两个数据表：
我们可以引入一个没有含义的id列，用来做唯一识别，为了查找效率高，我们使用数值型id，类似系统号。

**🎬 07-展示数据表-双表**
我们可以引入一个没有含义的id列，用来做唯一识别，为了查找效率高，我们使用数值型id，类似系统号。

用户表（users）- 身份证档案：
```
id | username | password_hash
---|----------|---------------
1  | 小明     | 123456        
2  | 小红     | 654321        
3  | 小红     | 666666        
```
这样虽然用户名重复了，然后登录时以id登陆，这样就可以解决用户名重名的问题。
但是这样用户名在显示时还是难以区分，所以我们最好还是设置成username不允许重复注册，可以把username字段设为unique。

排行榜表（leaderboard）- 游戏记录：
```
id | user_id | score | timestamp  
---|---------|-------|------------
1  | 1    | 500   | 2024-01-01
2  | 2    | 450   | 2024-01-01
3  | 3    | 600   | 2024-01-01
```
看！现在每个分数都有对应的用户ID，不会再出现随意填写名称的情况了。

要把这两张表关联在一起，需要有一个“外键”。
外键的定义：一个表（子表）中的一列（或多列）引用了另一个表（父表）的主键。

通过外键可以避免数据冗余：一个信息应该尽量只在一个地方存储。如果多个表需要相同信息（如用户名），应通过主键-外键引用关联的表，而不是在每个表里都存储一份用户名。

**🎬 08-展示拆表和不拆表的对比图**
大家看，这样我们就只需要在用户表中存储一次用户名和密码，而不需要在排行榜表中存储多次，避免了数据冗余。

单表：
```
leaderboard表
+----+----------+---------------+-------+---------------------+
| id | username | password_hash | score | timestamp           |
+----+----------+---------------+-------+---------------------+
| 1  | 小明     | 123456        | 150   | 2023-05-01 10:00    |
| 2  | 小红     | 654321        | 120   | 2023-05-01 11:00    |
| 3  | 小红     | 654321        | 130   | 2023-05-01 12:00    |
| 4  | 小红     | 654321        | 120   | 2023-05-01 13:00    |
| 5  | 小红     | 654321        | 100   | 2023-05-01 14:00    |
+----+----------+---------------+-------+---------------------+
```
双表：
用户表（users）
```
id | username | password_hash
---|----------|---------------
1  | 小明     | 123456        
2  | 小红     | 654321             
```

排行榜表（leaderboard）
```
id | user_id | score | timestamp  
---|---------|-------|------------
1  | 1    | 150   | 2023-05-01 10:00 
2  | 2    | 120   | 2023-05-01 11:00
3  | 2    | 130   | 2023-05-01 12:00
4  | 2    | 120   | 2023-05-01 13:00
3  | 2    | 100   | 2023-05-01 14:00 
```


#### 飞哥：
总结一下，拆成多张表可以实现哪些功能？

#### 刘泓：
1. 用户有唯一的id
2. 数据不冗余
3. 数据一致性
4. 用户数据可以记录、查询

这就是数据库设计的魅力：通过合理的表结构关联，解决实际的业务问题！
我们今天只学习到双表设计，实际的使用中会有更多的复杂场景，比如多表关联查询、事务处理等。

#### 飞哥：
不过，现在虽然有两个表了，但是这还是独立的两个表格，用户名和分数分散在两张表里，那我想查用户分数时应该怎么查？

#### 刘泓：
这就需要用到数据库的关联查询。
关联查询可以根据两个表之间的关联字段，将它们合并成一个结果集。
比如，我们可以根据用户表的id字段，查询出排行榜表中所有属于该用户的游戏记录。

上节课我们学习了“主键”的概念，主键是每个表中唯一标识一条记录的字段。
在用户表中，id字段就是主键，每个用户的id都是唯一的。
在排行榜表中，user_id字段就是关联字段，它引用了用户表的id字段。
通过关联字段，我们可以将两个表连接起来，实现数据的关联查询。

在进行数据关联查询时，我们会用到sql语言！

**🎬 09-展示sql查询代码**
就像银行查账时，通过身份证号找到客户姓名一样，我们可以通过关联字段，将两个表连接起来，找到我们需要的信息。

实际的查询逻辑：
```sql
-- 获取实名排行榜
SELECT 
    u.username,  -- 从用户表获取昵称
    l.score,     -- 从排行榜表获取分数
    l.timestamp  -- 从排行榜表获取时间
FROM leaderboard l , users u
where l.user_id = u.id 
ORDER BY l.score DESC;

```
也可以通过“JOIN"语句进行查询：
```sql
SELECT u.username, l.score 
FROM users u
INNER JOIN leaderboard l ON u.id = l.user_id
```

#### 飞哥：
大家不用担心看不懂SQL，AI会帮我们生成这些代码！重要的是理解这个关联思路。
接下来进入我们今天的第一个送礼环节，我们先来一道抢答题热热身！

**🎬 10-展示抢答题1**
```
抢答题1：多表关联设计的优势是？
A. 实名认证，保证用户真实身份
B. 减少数据冗余、保证数据一致性
C. 数据查询速度更快
D. 可以防止恶意刷分和作弊
答案：B
```

### 三、实操：AI生成用户登录系统并升级数据库

#### 飞哥：
现在大家理解了双表设计的基本原理了，我们来让AI帮我们执行吧！
我是不是直接告诉Trae"帮我做个用户系统"就可以了？

#### 刘泓：
这样说的话，AI会无法精准理解我们的需求，做出来的系统可能不是我们想要的效果。

#### 飞哥：
那我应该怎么说？请泓老师演示一下高端操作！

#### 刘泓：
**🎬 投屏演示**
现在重点来了！如何让AI理解我们要做"数据表关联"？
正确的做法，是要用通俗的语言描述清楚我们的具体需求：

**🎬 11-展示提示词**
```
我有一个贪吃蛇游戏，现在的排行榜有个问题：

【当前情况】
- 任何人都可以随便输入名字，比如输入"游戏大神"
- 没办法知道这些分数到底是谁的
- 同一个人可以用不同名字反复上榜

【我想要的效果】
- 用户需要先注册账号才能玩游戏
- 排行榜显示的是真实的用户名
- 每个用户可以查看自己的历史成绩

请帮我加上用户注册登录系统，让游戏能认识每个玩家。
```
看！我们重点描述了数据结构的变化和关联需求，这样AI就知道要做什么了！

（点击发送，等待AI回复）
太棒了！AI完美理解了我们的数据关联需求！让我们看看AI的设计方案！

1. 用户表设计（身份证档案）：
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,           -- 用户唯一身份ID
    username VARCHAR(50) UNIQUE,      -- 登录用户名（不能重复）《防止多个人用同一用户名》
    password_hash VARCHAR(255),       -- 加密密码
    created_at TIMESTAMP             -- 注册时间
);
```
就像给每个人发了一张身份证！

2. 排行榜表升级（交易记录）：
```sql
-- 升级后的表结构  
CREATE TABLE leaderboard (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,              -- 关键：关联到用户表的ID
    score INTEGER,
    timestamp DATETIME,
    FOREIGN KEY (user_id) REFERENCES users(id)  -- 外键约束
);
```
看！现在每个分数都有明确的主人了！

3. 数据关联查询（核心魔法）：
```sql
-- 实名排行榜查询
SELECT 
    u.username AS 玩家昵称,
    l.score AS 游戏分数,
    l.timestamp AS 游戏时间
FROM leaderboard l 
JOIN users u ON l.user_id = u.id    -- 通过user_id关联两个表
ORDER BY l.score DESC 
LIMIT 10;
```
就像银行通过身份证号查找客户所有交易记录！

4. 前端登录注册页面：
AI还为我们生成了简洁的用户界面！

#### 飞哥：
我还有一个疑问，用户登录后，分数是如何自动绑定到用户的？

#### 刘泓：
AI生成的后端逻辑很巧妙：
```python
# 用户提交分数时
def submit_score(score):
    user_id = session.get('user_id')  # 获取当前登录用户ID
    if user_id:
        # 分数自动绑定到用户
        cursor.execute("INSERT INTO leaderboard (user_id, score, timestamp) VALUES (?, ?, ?)", 
                      (user_id, score, datetime.now()))
    else:
        return "请先登录"
```
这样系统就知道每个分数是谁创造的了！

#### 飞哥：
让我们出第二道抢答题！
**🎬 12-展示抢答题2**
```
抢答题2：SQL查询语句 "SELECT u.nickname, l.score FROM leaderboard l JOIN users u ON l.user_id = u.id" 的作用是？
A. 插入用户名和分数数据
B. 查询用户名和对应分数
C. 创建新的用户表
D. 更新用户密码
答案：B
```

### 四、部署测试：看看实际效果
#### 飞哥：
现在让我们把AI生成的代码部署起来，看看实际效果！

#### 刘泓：
**🎬 投屏演示**

升级步骤很简单：
1. 创建用户数据表
2. 更新后端服务代码
3. 添加登录注册页面
4. 重启服务

（演示实际操作过程）

现在让我们测试升级效果！

#### 飞哥：
**🎬 13-展示游戏地址**
http://test.kepilot.com/snake-game.html
现在大家都可以通过网址登陆并注册我们的游戏了，快来试试吧！
今天的最后一个礼物，就从我们游戏的第一批用户中抽取——现在开始计时，3分钟后，从用户id中随机抽取一名幸运中奖者！
用户名必须和抖音名一致，以便我们联系大家发奖。

#### 刘泓：
我们一起测试一下游戏效果：

测试1：用户注册
我现在注册一个新账号"测试用户001"
（实际操作注册流程）
看！系统成功创建了用户档案！

测试2：用户登录
现在我用刚才注册的账号登录
（实际操作登录流程）  
登录成功！系统已经认识我是谁了！

测试3：数据关联效果
现在我来玩一局游戏，看看数据表关联是否生效！
（实际玩游戏，提交分数）
太神奇了！分数自动绑定到user_id=1，系统知道这是"测试用户001"的成绩！

测试4：实名排行榜的数据关联
让我们看看JOIN查询的实际效果
（展示排行榜页面）
看！排行榜通过JOIN查询，显示的是users表中的真实昵称，而不是随意输入的名字！

测试5：个人历史的数据筛选
现在查看个人记录，看看数据筛选效果
（展示个人记录页面）
完美！通过WHERE user_id=1的条件，系统只显示当前用户的历史记录！


### 五、尾声
#### 飞哥：
在大家体验我们游戏的同时，请泓老师对今天的知识点做一个总结吧！

#### 刘泓：
**🎬 14-展示知识点总结**

今天我们学会了：
1. 用户体系设计：理解用户表和业务表的关联关系
2. 多表关联查询：学会用JOIN查询解决实际业务问题
3. 数据完整性：通过外键约束保证数据一致性  

#### 飞哥：
现在我们的游戏已经有了完整的用户体系，并收获了第一批种子用户。现在我作为游戏开发者，我想通过数据来判断大家喜不喜欢我的游戏，比如，我想知道用户平均游戏次数、最常玩的时间段、用户分数的分布等数据，比如大部分人都达不到100分，我们就需要调节游戏速度、降低难度，以提升游戏体验。应该怎么做呢？

#### 刘泓：
下期我们将学习更复杂的数据分析——引入用户行为分析表，学会多表关联的数据挖掘！

#### 飞哥：
我们的课程逐渐深入，理论说得再多，不如实际操作一遍！大家可以通过课后作业巩固课上所学的知识。
**🎬 15-展示课后作业说明**
本周的课后作业：为你们的游戏或应用添加一个用户注册登录系统，实现用户表和业务数据表的关联，支持用户身份验证和个人数据查询。

接下来是大家喜闻乐见的送礼环节～
首先，我们获取到了当前游戏的所有注册用户，进行抽奖。

**🎬 投屏-展示sql抽奖画面**
（通过sql在用户表中抽取一个幸运用户）
中奖用户是xx，恭喜你获得今天第三个电子宠物机。
接下来，是本场互动榜第一的用户，昵称是xx，也恭喜你获得小度智能音箱随身版！

那我们本期内容就到这里，感谢大家的积极参与，记得完成我们的课后测验和作业，及时巩固自己的学习效果，下周同一时间我们不见不散！


### 练习题
单选题

1. 在数据库设计中，用户表的主要作用类似于什么？
A. 银行交易记录
B. 身份证档案
C. 游戏规则
D. 操作日志
正确答案：B

2. SQL查询语句 "SELECT u.nickname, l.score FROM leaderboard l JOIN users u ON l.user_id = u.id" 的作用是？
A. 插入用户名和分数数据
B. 查询用户名和对应分数
C. 创建新的用户表
D. 更新用户密码
答案：B

3. 在排行榜表中，user_id字段的主要作用是什么？
A. 存储用户密码
B. 记录游戏时间
C. 关联到用户表的唯一标识
D. 显示用户昵称
正确答案：C

4. JOIN查询在数据库中的主要功能是什么？
A. 删除重复数据
B. 关联多个表的数据进行查询
C. 创建新的数据表
D. 备份数据库
正确答案：B

多选题（6题）

5. 多表关联设计的优势是？
A. 实名认证，保证用户真实身份
B. 减少数据冗余、保证数据一致性
C. 数据查询速度更快
D. 可以防止恶意刷分和作弊
答案：B

6. 数据库表关联设计解决了哪些实际问题？
A. 任何人都可以随便输入名字的问题
B. 刷新页面就找不到自己成绩的问题
C. 无法防止恶意刷分的问题
D. 没有个人游戏历史记录的问题
正确答案：ABCD

7. 在SQL查询中，JOIN操作可以实现哪些功能？
A. 通过用户ID关联两个表
B. 获取用户的真实昵称
C. 显示用户的游戏分数
D. 按分数排序显示结果
正确答案：ABCD

判断题（6题）

8. 用户注册时，密码应该以明文形式存储在数据库中。
正确 / 错误
正确答案：错误

9. JOIN查询只能关联两个数据表，不能关联更多表。
正确 / 错误
正确答案：错误

10. 引入用户体系后，用户必须先注册登录才能提交游戏分数。
正确 / 错误
正确答案：正确






